pipeline {
    agent any

    environment {
        NODE_ENV = 'test'
        GCP_PROJECT_ID = credentials('gcp-project-id')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies - Main Website') {
            steps {
                dir('mainwebsite') {
                    sh 'npm install'
                }
            }
        }

        stage('Install Dependencies - Metrics') {
            steps {
                dir('metrics') {
                    sh 'npm install'
                }
            }
        }

        stage('Lint - Main Website') {
            steps {
                dir('mainwebsite') {
                    sh 'npm run lint || true'
                }
            }
        }

        stage('Lint - Metrics') {
            steps {
                dir('metrics') {
                    sh 'npm run lint || true'
                }
            }
        }

        stage('Unit Tests - Main Website') {
            steps {
                dir('mainwebsite') {
                    sh 'npm run test'
                }
            }
        }

        stage('E2E Tests - Main Website') {
            steps {
                dir('mainwebsite') {
                    sh 'npm run test:e2e'
                }
            }
        }

        stage('Unit Tests - Metrics') {
            steps {
                dir('metrics') {
                    sh 'npm test'
                }
            }
        }

        stage('Security Scan - OWASP Dependency-Check') {
            steps {
                script {
                    sh '''
                        dependency-check --project "mainwebsite" --scan mainwebsite/node_modules --format JSON --out mainwebsite-dependency-check.json || true
                        dependency-check --project "metrics" --scan metrics/node_modules --format JSON --out metrics-dependency-check.json || true
                    '''
                }
            }
        }

        stage('Build Verification - Main Website') {
            steps {
                dir('mainwebsite') {
                    sh 'npm run build'
                }
            }
        }

        stage('Dockerfile Validation') {
            steps {
                script {
                    sh '''
                        hadolint mainwebsite/Dockerfile || true
                        hadolint metrics/Dockerfile || true
                    '''
                }
            }
        }

        stage('Kubernetes Manifest Validation') {
            steps {
                script {
                    sh '''
                        kubectl apply --dry-run=client -f k8s-manifests/ --recursive || true
                    '''
                }
            }
        }
    }

    post {
        always {
            junit allowEmptyResults: true, testResults: 'mainwebsite/test-results/**/*.xml'
            archiveArtifacts artifacts: '*-dependency-check.json', allowEmptyArchive: true
        }
        success {
            echo 'Validation pipeline completed successfully!'
        }
        failure {
            echo 'Validation pipeline failed!'
        }
    }
}

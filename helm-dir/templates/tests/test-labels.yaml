{{- if .Values.mainwebsite.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "helm-dir.fullname" . }}-test-mainwebsite-labels"
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
  labels:
    {{- include "helm-dir.labels" . | nindent 4 }}
    app.kubernetes.io/component: mainwebsite
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  serviceAccountName: {{ include "helm-dir.serviceAccountName" . }}
  containers:
    - name: kubectl
      image: bitnami/kubectl:latest
      command:
        - sh
        - -c
        - |
          echo "Verifying mainwebsite deployment labels and selectors..."
          
          # Check deployment exists
          kubectl get deployment {{ include "helm-dir.fullname" . }}-mainwebsite -n {{ .Values.global.namespace | default .Release.Namespace }}
          if [ $? -ne 0 ]; then
            echo "✗ Mainwebsite deployment not found"
            exit 1
          fi
          
          # Check pods have correct labels
          POD_COUNT=$(kubectl get pods -n {{ .Values.global.namespace | default .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }},app.kubernetes.io/component=mainwebsite --no-headers | wc -l)
          if [ "$POD_COUNT" -gt 0 ]; then
            echo "✓ Found $POD_COUNT mainwebsite pod(s) with correct labels"
          else
            echo "✗ No mainwebsite pods found with expected labels"
            exit 1
          fi
          
          # Check service has correct selector
          SERVICE_SELECTOR=$(kubectl get svc {{ include "helm-dir.fullname" . }}-mainwebsite -n {{ .Values.global.namespace | default .Release.Namespace }} -o jsonpath='{.spec.selector}')
          echo "✓ Service selector: $SERVICE_SELECTOR"
          
          exit 0
  restartPolicy: Never
{{- end }}
